<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PlayerUnion ID | Dashboard</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; padding: 40px; text-align: center; }
        .card { background: #1e293b; padding: 20px; border-radius: 10px; margin: 10px auto; max-width: 500px; border: 1px solid #334155; }
        input { width: 80%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
        button { padding: 10px 20px; background: #7000ff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #union-card { display: none; border-left: 5px solid #00f2ff; text-align: left; }
        .game-item { padding: 8px 0; border-bottom: 1px solid #334155; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>PLAYERUNION ID</h1>
    <div class="card">
        <h3>1. Registrieren</h3>
        <input type="text" id="uname" placeholder="Username">
        <button onclick="reg()">Erstellen</button>
    </div>
    <div class="card">
        <h3>2. Steam Link</h3>
        <input type="text" id="pid" placeholder="Pulse-ID">
        <input type="text" id="sid" placeholder="SteamID64">
        <button onclick="link()">Verkn端pfen</button>
    </div>
    <div id="union-card" class="card">
        <h2 id="name"></h2>
        <p id="status"></p>
        <div id="games"></div>
    </div>

    <script>
    async function reg() {
        try {
            const r = await fetch('/players', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: document.getElementById('uname').value})
            });
            if (!r.ok) throw new Error('Registrierung fehlgeschlagen');
            const d = await r.json();
            document.getElementById('pid').value = d.id;
            alert("Erfolgreich registriert! Deine ID ist: " + d.id);
        } catch (err) {
            alert("Fehler: " + err.message);
        }
    }

    async function link() {
        const pid = document.getElementById('pid').value;
        if (!pid) return alert("Bitte zuerst registrieren!");
        try {
            const r = await fetch(`/players/${pid}/link`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({steam_id: document.getElementById('sid').value})
            });
            if (!r.ok) throw new Error('Verkn端pfung fehlgeschlagen');
            load(pid);
        } catch (err) {
            alert("Fehler beim Verkn端pfen: " + err.message);
        }
    }

    async function load(pid) {
        try {
            const r = await fetch(`/players/${pid}/card`);
            if (!r.ok) throw new Error('Card konnte nicht geladen werden');
            const d = await r.json();

            document.getElementById('union-card').style.display = 'block';
            document.getElementById('name').innerText = d.steam.personaname;
            document.getElementById('status').innerText = "Spiele gefunden: " + d.games.length;

            const gamesDiv = document.getElementById('games');
            gamesDiv.innerHTML = '<h3>Spiele & Spielzeit:</h3>';

            d.games.forEach(game => {
                const hours = (game.playtime_forever / 60).toFixed(1);
                const gameElem = document.createElement('div');
                gameElem.className = 'game-item';
                // Wichtig: Backticks ` benutzen f端r die Variablen-Einsetzung!
                gameElem.innerHTML = `<strong>${game.name}</strong> - ${hours} Stunden`;
                gamesDiv.appendChild(gameElem);
            });
        } catch (err) {
            console.error(err);
        }
    }
    </script>
</body>
</html>