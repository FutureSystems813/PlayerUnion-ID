<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PlayerUnion ID | Dashboard</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --accent: #7000ff;
            --border: #334155;
            --neon: #00f2ff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: white; padding: 40px; text-align: center; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 12px; margin: 15px auto; max-width: 550px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        input { width: 85%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid var(--border); background: #0f172a; color: white; }
        button { width: 90%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        #union_card { display: none; border-left: 5px solid var(--neon); text-align: left; }
        .game_item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.95em; }
        .playtime { color: var(--neon); font-weight: bold; }
        h1 { letter-spacing: 2px; text-transform: uppercase; }
    </style>
</head>
<body>
    <h1>PLAYERUNION ID</h1>

    <div class="card">
        <h3>1. Registrieren</h3>
        <input type="text" id="uname" placeholder="Username">
        <button onclick="register_user()">Account erstellen</button>
    </div>

    <div class="card">
        <h3>2. Steam Link</h3>
        <input type="text" id="pid" placeholder="Pulse-ID">
        <input type="text" id="sid" placeholder="SteamID64">
        <button onclick="link_steam()">Verknüpfen</button>
    </div>

    <div id="union_card" class="card">
        <h2 id="display_name"></h2>
        <p id="game_count_status"></p>
        <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
        <div id="game_list"></div>
    </div>

    <script>
    async function register_user() {
        const username_input = document.getElementById('uname').value;
        try {
            const response = await fetch('/players', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: username_input})
            });

            if (!response.ok) throw new Error('Registrierung fehlgeschlagen');

            const data = await response.json();
            document.getElementById('pid').value = data.id;
            alert(`Erfolgreich registriert! Deine ID: ${data.id}`);
        } catch (error) {
            alert(`Fehler: ${error.message}`);
        }
    }

    async function link_steam() {
        const player_id = document.getElementById('pid').value;
        const steam_id = document.getElementById('sid').value;

        if (!player_id) return alert("Bitte zuerst registrieren!");

        try {
            const response = await fetch(`/players/${player_id}/link`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({steam_id: steam_id})
            });

            if (!response.ok) throw new Error('Verknüpfung fehlgeschlagen');

            load_player_card(player_id);
        } catch (error) {
            alert(`Fehler beim Verknüpfen: ${error.message}`);
        }
    }

    async function load_player_card(player_id) {
        try {
            const response = await fetch(`/players/${player_id}/card`);
            if (!response.ok) throw new Error('Card konnte nicht geladen werden');

            const data = await response.json();

            document.getElementById('union_card').style.display = 'block';
            document.getElementById('display_name').innerText = data.steam.personaname;

            const list_container = document.getElementById('game_list');
            list_container.innerHTML = '<h3>Deine Top Spiele:</h3>';

            if (data.games && data.games.length > 0) {
                let total_minutes = 0; // Variable zum Summieren

                // Sortierung (Snake Case)
                const sorted_games = [...data.games].sort((game_a, game_b) => {
                    return game_b.playtime_forever - game_a.playtime_forever;
                });

                sorted_games.forEach(game => {
                    total_minutes += game.playtime_forever; // Zeit addieren

                    const hours_played = (game.playtime_forever / 60).toFixed(1);
                    const game_row = document.createElement('div');
                    game_row.className = 'game_item';

                    game_row.style.display = 'flex';
                    game_row.style.justifyContent = 'space-between';
                    game_row.style.padding = '8px 0';
                    game_row.style.borderBottom = '1px solid #334155';

                    game_row.innerHTML = `
                        <span>${game.name}</span>
                        <span style="color: #00f2ff; font-weight: bold;">${hours_played} Std.</span>
                    `;

                    list_container.appendChild(game_row);
                });

                // Gesamtspielzeit oben anzeigen (neben der Anzahl der Spiele)
                const total_hours = (total_minutes / 60).toFixed(0);
                document.getElementById('game_count_status').innerText =
                    `Spiele gefunden: ${data.games.length} | Gesamtspielzeit: ${total_hours} Stunden`;

            } else {
                list_container.innerHTML += '<p>Keine öffentlichen Spieldaten gefunden.</p>';
            }
        } catch (error) {
            console.error("Fehler im Frontend:", error);
        }
    }
    </script>
</body>
</html>